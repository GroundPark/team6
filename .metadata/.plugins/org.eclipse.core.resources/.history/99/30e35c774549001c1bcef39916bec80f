package product.act;

import javax.servlet.http.*;
import product.vo.*;
import java.util.*;
import product.svc.*;
import java.io.*;
import java.net.*;

public class PdtListAct implements Action{
	public ActionForward execute(HttpServletRequest request, HttpServletResponse response) throws Exception{
		request.setCharacterEncoding("utf-8");
		ArrayList<ProductInfo> pdtList = new ArrayList<ProductInfo>();
			
		int cpage = 1, psize = 12, bsize = 10, spage, epage, rcnt, pcnt;		// 적당히 조절하셈
		if(request.getParameter("cpage") != null)
			cpage = Integer.parseInt(request.getParameter("cpage"));
		if(request.getParameter("psize") != null)
			psize = Integer.parseInt(request.getParameter("psize"));
		
		
		// 검색조건 : 검색어, 분류, 브랜드, 가격대
		String keyword, cata, brand, sprice, eprice;
		keyword = request.getParameter("keyword");		// 검색어
		cata = request.getParameter("cata");			// 분류
		sprice = request.getParameter("sprice");		// 가격대 중 시작 가격
		eprice = request.getParameter("eprice");		// 가격대 중 종료 가격
		
		String where = " where a.pcs_id = c.pcs_id and b.pcb_id = c.pcb_id and a.pb_id = d.pb_id and a.pi_isview = 'y' ";
		if(!isEmpty(keyword))	where += " and a.pi_name like '%" + keyword + "%' ";
		else keyword = "";
		
		if(!isEmpty(cata))		where += " and b.pcd_id = '" + cata + "' ";
		else cata = "";
		
		if(!isEmpty(sprice))	where += " and a.pi_price >= '" + sprice + "' ";
		else sprice = "";
		
		if(!isEmpty(eprice))	where += " and a.pi_price <= '" + eprice + "' ";
		else eprice = "";
		
		// 정렬 조건 : 판매량(내림차), 가격-오름+내림, 상품명-오름차, 리뷰-내림차, 조회-내림차, 평점-내림차, 등록-내림차(기본)
		// 정렬 기준은 1개만... 굳이 그 이상 해봣자 티도 안남 // 규칙 : 오름차는 뒤에 a, 내림차는 뒤에 d
		String sort = request.getParameter("sort");
		if(sort == null || sort.equals(""))		sort = "idd";		// 정렬 기본값 : 상품 등록 역순 정렬
		
		// 정렬 기준에 따른 order by 절 생성
		String order = " order by pi_" + sort.substring(0, sort.length() - 1) 
			+ (sort.charAt(sort.length() - 1) == 'a' ? " asc" : " desc");
		
		PdtListSvc pdtListSvc = new PdtListSvc();
		rcnt = pdtListSvc.getPdtCount(where);		
		// 검색된 상품의 총 개수 : 페이징을 위해 필요
		
		pdtList = pdtListSvc.getPdtList(where, order, cpage, psize);
		// cpage에서 보여줄 검색된 상품목록을 받아옴
		
		pcnt = rcnt / psize;
		if(rcnt % psize > 0)	pcnt++;				// 전체 페이지 개수
		spage = (cpage - 1) / bsize * bsize + 1;	// 블록의 시작 페이지 번호
		epage = spage + bsize - 1;
		if(epage > pcnt)	epage = pcnt;			// 블록의 종료 페이지 번호
		
		PdtPageInfo pdtPageInfo = new PdtPageInfo();// 페이징에 필요한 정보들을 저장할 인스턴스
		pdtPageInfo.setCpage(cpage);    pdtPageInfo.setPsize(psize);        pdtPageInfo.setBsize(bsize);
        pdtPageInfo.setSpage(spage);    pdtPageInfo.setEpage(epage);        pdtPageInfo.setRcnt(rcnt);
        pdtPageInfo.setPcnt(pcnt);      pdtPageInfo.setKeyword(keyword);    pdtPageInfo.setcata(cata);
        pdtPageInfo.setSprice(sprice);  pdtPageInfo.setEprice(eprice);    	pdtPageInfo.setSort(sort);
		
        ArrayList<PdtCataBig> cataBigList = pdtListSvc.getCataBigList();
        ArrayList<PdtCataSmall> cataSmallList = pdtListSvc.getCataSmallList();
        ArrayList<PdtBrandInfo> brandInfoList = pdtListSvc.getBrandInfoList();
        
        request.setAttribute("pdtPageInfo", pdtPageInfo);
        request.setAttribute("pdtList", pdtList);
        request.setAttribute("cataBigList", cataBigList);
        request.setAttribute("cataSmallList", cataSmallList);
        request.setAttribute("brandInfoList", brandInfoList);
        // 생성할 인스턴스들을 request 객체의 속성으로 저장하여 이동할 페이지로 가져감
        
        ActionForward forward = new ActionForward();
		forward.setPath("/product/pdt_list.jsp");
		
		return forward;
	}
	
	private boolean isEmpty(String str) {		// 문자열에 어떤 값이든 들어 있는지 여부를 검사하는 메소드
		boolean empty = true;
		if(str != null && !str.equals("")) empty = false;
		return empty;
	}
}
